{% extends "base.html" %}

{% block title %}Room Allocation{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1><i class="fas fa-map"></i> Room Allocation</h1>
        <p>Book classrooms and manage your room reservations</p>
    </div>

    <!-- Two-Column Layout as per specification -->
    <div class="two-column-layout">
        <!-- Left Panel: Find & Book Rooms -->
        <div class="left-panel">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-search"></i> Find & Book Rooms</h3>
                </div>
                <div class="card-body">
                    <!-- Search Bar -->
                    <div class="form-group">
                        <label for="roomSearch">Search Rooms</label>
                        <div class="search-input-group">
                            <input type="text" id="roomSearch" placeholder="Search by Room ID or Room Name..." onkeyup="filterRooms()">
                            <button type="button" class="search-btn" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Room Type Filter -->
                    <div class="form-group">
                        <label for="filterRoomType">Room Type</label>
                        <select id="filterRoomType" onchange="filterRooms()">
                            <option value="">All Types</option>
                            <option value="classroom">Classroom</option>
                            <option value="lab">Lab</option>
                            <option value="seminar">Seminar Hall</option>
                            <option value="auditorium">Auditorium</option>
                        </select>
                    </div>

                    <!-- Clear Filters Button -->
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary btn-block" onclick="clearFilters()">
                            <i class="fas fa-eraser"></i> Clear Filters
                        </button>
                    </div>

                    <!-- Test Buttons for Debugging -->
                    <div class="form-group" style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                        <small class="text-muted">Debug Tools:</small><br>
                        <button type="button" class="btn btn-info btn-sm" onclick="testLoadRooms()" style="margin: 2px;">
                            Test Load Rooms
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="testBooking()" style="margin: 2px;">
                            Test Booking
                        </button>
                        <button type="button" class="btn btn-success btn-sm" onclick="testSuccessModal()" style="margin: 2px;">
                            Test Success Modal
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="checkAuthStatus()" style="margin: 2px;">
                            Check Auth
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="testFacultyLogin()" style="margin: 2px;">
                            Test Faculty Login
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="checkRoomAvailability()" style="margin: 2px;">
                            Check Availability
                        </button>
                    </div>

                    <hr>

                    <!-- Booking Details -->
                    <h4><i class="fas fa-calendar"></i> Booking Details</h4>
                    <div class="form-group">
                        <label for="bookingDate">Date</label>
                        <input type="date" id="bookingDate" name="date" required min="">
                    </div>
                    <div class="form-group">
                        <label for="startTime">Start Time</label>
                        <input type="time" id="startTime" name="start_time" required>
                    </div>
                    <div class="form-group">
                        <label for="endTime">End Time</label>
                        <input type="time" id="endTime" name="end_time" required>
                    </div>
                    <div class="form-group">
                        <label for="courseName">Course Name</label>
                        <input type="text" id="courseName" name="course_name" placeholder="e.g., Data Structures">
                    </div>
                    <div class="form-group">
                        <label for="expectedStudents">Expected Students</label>
                        <input type="number" id="expectedStudents" name="expected_students" min="1" placeholder="30">
                    </div>
                    <div class="form-group">
                        <label for="purpose">Purpose</label>
                        <textarea id="purpose" name="purpose" rows="3" placeholder="Describe the purpose..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Room Availability -->
        <div class="right-panel">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> Room Availability</h3>
                    <div class="header-controls">
                        <span id="roomsCount" class="rooms-count">0 rooms</span>
                        <button class="btn btn-secondary" onclick="loadAllRooms()" id="refreshRoomsBtn">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Loading Indicator -->
                    <div id="roomsLoading" class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading rooms...</div>
                    </div>

                    <!-- Rooms Table -->
                    <div id="roomsTableContainer" style="display: none;">
                        <table class="rooms-table" id="roomsTable">
                            <thead>
                                <tr>
                                    <th>Room ID</th>
                                    <th>Room Name</th>
                                    <th>Type</th>
                                    <th>Capacity</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="roomsTableBody">
                                <!-- Rooms will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- No Rooms Message -->
                    <div id="noRoomsMessage" class="no-data-message" style="display: none;">
                        <i class="fas fa-building"></i>
                        <h4>No Rooms Found</h4>
                        <p>No rooms match your current search criteria.</p>
                    </div>
                </div>
            </div>

            <!-- My Bookings Section (below Room Availability) -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3><i class="fas fa-calendar-check"></i> My Bookings</h3>
                    <div class="header-controls">
                        <span id="bookingsCount" class="bookings-count">0 bookings</span>
                        <button class="btn btn-secondary" onclick="loadMyBookings()" id="refreshBookingsBtn">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Loading Indicator -->
                    <div id="bookingsLoading" class="loading-container" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading bookings...</div>
                    </div>

                    <!-- Bookings List -->
                    <div id="myBookingsList">
                        <!-- Bookings will be populated here -->
                    </div>

                    <!-- No Bookings Message -->
                    <div id="noBookingsMessage" class="no-data-message" style="display: none;">
                        <i class="fas fa-calendar-times"></i>
                        <h4>No Bookings Found</h4>
                        <p>You haven't made any room bookings yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- My Bookings -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-calendar-check"></i> My Bookings</h3>
            <button class="btn btn-secondary" onclick="loadMyBookings()">
                <i class="fas fa-refresh"></i> Refresh
            </button>
        </div>
        <div class="card-body">
            <div id="myBookingsList">
                <div class="loading">Loading your bookings...</div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Confirmation Modal -->
<div id="bookingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Room Booking</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="bookingDetails"></div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="confirmBooking()">Confirm Booking</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal with Green Check Animation -->
<div id="successModal" class="modal">
    <div class="modal-content success-modal">
        <div class="modal-body text-center">
            <div class="success-animation">
                <div class="checkmark-circle">
                    <div class="checkmark"></div>
                </div>
            </div>
            <h3 id="successMessage">Room IT601 booked successfully!</h3>
            <p id="successDetails">You will be redirected to My Bookings in <span id="countdown">3</span> seconds...</p>
        </div>
    </div>
</div>

<style>
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

/* Two-Column Layout */
.two-column-layout {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.left-panel {
    min-height: 600px;
}

.right-panel {
    min-height: 600px;
}

/* Rooms Table */
.rooms-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.rooms-table th,
.rooms-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.rooms-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #2c3e50;
}

.rooms-table tbody tr:hover {
    background-color: #f5f5f5;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
}

.status-available {
    background: #d4edda;
    color: #155724;
}

.status-booked {
    background: #f8d7da;
    color: #721c24;
}

.status-unavailable {
    background: #fff3cd;
    color: #856404;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.header {
    text-align: center;
    margin-bottom: 30px;
}

.header h1 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow: hidden;
}

.card-header {
    background: #3498db;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-body {
    padding: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: bold;
    margin-bottom: 5px;
    color: #2c3e50;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-warning {
    background: #f39c12;
    color: white;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.room-item {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.room-info h4 {
    margin: 0 0 5px 0;
    color: #2c3e50;
}

.room-info p {
    margin: 0;
    color: #7f8c8d;
    font-size: 14px;
}

.booking-item {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.booking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.booking-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.status-confirmed {
    background: #d4edda;
    color: #155724;
}

.status-waiting {
    background: #fff3cd;
    color: #856404;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 0;
    border-radius: 10px;
    width: 80%;
    max-width: 500px;
}

.modal-header {
    background: #3498db;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 10px 10px 0 0;
}

.modal-body {
    padding: 20px;
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.close {
    font-size: 24px;
    cursor: pointer;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #7f8c8d;
}

.alert {
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 15px;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* Search and Filter Styles */
.search-controls {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.search-input-group {
    position: relative;
    display: flex;
}

.search-input-group input {
    flex: 1;
    padding-right: 40px;
}

.search-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 5px;
}

.search-btn:hover {
    color: #495057;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.rooms-count {
    background: rgba(255,255,255,0.2);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 14px;
}

/* Loading Animations */
.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: #6c757d;
    font-size: 16px;
}

/* Button Loading States */
.btn.loading {
    position: relative;
    color: transparent !important;
}

.btn.loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    color: white;
}

/* Room Item Enhancements */
.room-item {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    position: relative;
}

.room-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.room-item.available {
    border-left: 4px solid #27ae60;
}

.room-item.unavailable {
    border-left: 4px solid #e74c3c;
    opacity: 0.7;
}

.room-item.checking {
    border-left: 4px solid #f39c12;
}

.room-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.room-title {
    margin: 0;
    color: #2c3e50;
    font-size: 18px;
}

.room-status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
}

.status-available {
    background: #d4edda;
    color: #155724;
}

.status-unavailable {
    background: #f8d7da;
    color: #721c24;
}

.status-checking {
    background: #fff3cd;
    color: #856404;
}

.room-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.room-detail-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #6c757d;
    font-size: 14px;
}

.room-detail-item i {
    width: 16px;
    color: #3498db;
}

.room-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* No Data Message */
.no-data-message {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.no-data-message i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #dee2e6;
}

.no-data-message h4 {
    margin-bottom: 10px;
    color: #495057;
}

/* Success Modal Animation */
.success-modal {
    max-width: 400px;
}

.success-animation {
    margin: 20px 0;
}

.checkmark-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #27ae60;
    margin: 0 auto;
    position: relative;
    animation: scaleIn 0.5s ease-in-out;
}

.checkmark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30px;
    height: 15px;
    border: 3px solid white;
    border-top: none;
    border-right: none;
    transform: translate(-50%, -60%) rotate(-45deg);
    animation: checkmarkDraw 0.5s ease-in-out 0.3s both;
}

@keyframes scaleIn {
    0% { transform: scale(0); }
    100% { transform: scale(1); }
}

@keyframes checkmarkDraw {
    0% { width: 0; height: 0; }
    100% { width: 30px; height: 15px; }
}

.text-center {
    text-align: center;
}

/* Responsive Design */
@media (max-width: 768px) {
    .two-column-layout {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .left-panel {
        min-height: auto;
    }

    .rooms-table {
        font-size: 14px;
    }

    .rooms-table th,
    .rooms-table td {
        padding: 8px;
    }
}
</style>

<script>
let allRooms = [];
let filteredRooms = [];
let selectedRoom = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bookingDate').min = today;

    // Add event listeners for availability checking
    document.getElementById('bookingDate').addEventListener('change', checkRoomAvailability);
    document.getElementById('startTime').addEventListener('change', checkRoomAvailability);
    document.getElementById('endTime').addEventListener('change', checkRoomAvailability);

    // Load all rooms initially
    loadAllRooms();
    loadMyBookings();
});

// Load all rooms from the server (API endpoint as per specification)
function loadAllRooms() {
    showLoading('roomsLoading', true);
    hideElement('roomsTableContainer');
    hideElement('noRoomsMessage');

    setButtonLoading('refreshRoomsBtn', true);

    // Using the specified API endpoint
    fetch('/api/faculty/rooms')
    .then(response => {
        console.log('Response status:', response.status);
        if (response.status === 401) {
            // User not logged in, try alternative endpoint
            console.log('Faculty endpoint requires login, trying alternative...');
            return fetch('/api/rooms/all').then(r => r.json());
        }
        return response.json();
    })
    .then(data => {
        console.log('Rooms data received:', data);
        if (data.error) {
            showToast('Failed to load rooms: ' + data.error, 'error');
            allRooms = [];
        } else {
            allRooms = data.rooms || [];
            console.log('Loaded rooms:', allRooms.length);
            if (allRooms.length > 0) {
                showToast(`Loaded ${allRooms.length} rooms`, 'success');
            }
        }

        filteredRooms = [...allRooms];
        displayRoomsTable();
        updateRoomsCount();
    })
    .catch(error => {
        console.error('Error loading rooms:', error);
        showToast('Failed to load rooms. Please try again.', 'error');
        allRooms = [];
        filteredRooms = [];
        displayRoomsTable();
    })
    .finally(() => {
        showLoading('roomsLoading', false);
        setButtonLoading('refreshRoomsBtn', false);
    });
}

// Check room availability for current date/time
function checkRoomAvailability() {
    const date = document.getElementById('bookingDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!date || !startTime || !endTime) {
        // If no date/time selected, show all rooms as available
        displayRoomsTable();
        return;
    }

    if (startTime >= endTime) {
        showToast('End time must be after start time', 'error');
        return;
    }

    // Check availability with backend
    const requestData = {
        date: date,
        start_time: startTime,
        end_time: endTime
    };

    fetch('/api/rooms/available', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Availability check error:', data.error);
            displayRoomsTable(); // Show all rooms if check fails
        } else {
            // Update room availability status
            const availableRoomIds = new Set((data.rooms || []).map(room => room.id));

            // Mark rooms as available/unavailable
            filteredRooms.forEach(room => {
                room.isAvailable = availableRoomIds.has(room.id);
            });

            displayRoomsTable();
        }
    })
    .catch(error => {
        console.error('Error checking availability:', error);
        displayRoomsTable(); // Show all rooms if check fails
    });
}

// Display rooms in table format (enhanced with availability checking)
function displayRoomsTable() {
    console.log('displayRoomsTable called with', filteredRooms.length, 'rooms');
    const tableContainer = document.getElementById('roomsTableContainer');
    const tableBody = document.getElementById('roomsTableBody');
    const noRoomsMessage = document.getElementById('noRoomsMessage');

    console.log('Table elements found:', {
        tableContainer: !!tableContainer,
        tableBody: !!tableBody,
        noRoomsMessage: !!noRoomsMessage
    });

    if (filteredRooms.length === 0) {
        console.log('No rooms to display');
        hideElement('roomsTableContainer');
        showElement('noRoomsMessage');
        return;
    }

    console.log('Showing rooms table');
    hideElement('noRoomsMessage');
    showElement('roomsTableContainer');

    // Clear existing rows
    tableBody.innerHTML = '';

    // Populate table rows
    filteredRooms.forEach(room => {
        const row = document.createElement('tr');

        // Determine status and action button based on availability
        let status, statusClass, actionButton;

        if (room.isAvailable === false) {
            // Room is unavailable for selected time
            status = 'Unavailable';
            statusClass = 'status-unavailable';
            actionButton = `<button class="btn btn-warning btn-sm" onclick="joinWaitingList('${room.id}', '${room.room_number}')" id="waiting-btn-${room.id}">Join Waiting List</button>`;
        } else {
            // Room is available or availability not checked
            status = 'Available';
            statusClass = 'status-available';
            actionButton = `<button class="btn btn-success btn-sm" onclick="bookRoom('${room.id}', '${room.room_number}')" id="book-btn-${room.id}">Book</button>`;
        }

        row.innerHTML = `
            <td>${room.room_number}</td>
            <td>${room.room_name || 'N/A'}</td>
            <td>${room.room_type || 'Classroom'}</td>
            <td>${room.capacity}</td>
            <td><span class="status-badge ${statusClass}">${status}</span></td>
            <td>${actionButton}</td>
        `;

        tableBody.appendChild(row);
    });
}

// Filter rooms based on search criteria (as per specification)
function filterRooms() {
    const searchTerm = document.getElementById('roomSearch').value.toLowerCase();
    const roomType = document.getElementById('filterRoomType').value;

    filteredRooms = allRooms.filter(room => {
        // Search filter (Room ID or Room Name as per specification)
        const matchesSearch = !searchTerm ||
            (room.room_number && room.room_number.toLowerCase().includes(searchTerm)) ||
            (room.room_name && room.room_name.toLowerCase().includes(searchTerm));

        // Room type filter
        const matchesType = !roomType || room.room_type === roomType;

        return matchesSearch && matchesType;
    });

    displayRoomsTable();
    updateRoomsCount();
}

// Clear all filters (as per specification)
function clearFilters() {
    document.getElementById('roomSearch').value = '';
    document.getElementById('filterRoomType').value = '';
    filterRooms();
}

// Book room function (enhanced for multiple consecutive bookings)
function bookRoom(roomId, roomNumber) {
    // Validate booking details
    const date = document.getElementById('bookingDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!date || !startTime || !endTime) {
        showToast('Please fill in Date, Start Time, and End Time', 'error');
        return;
    }

    if (startTime >= endTime) {
        showToast('End time must be after start time', 'error');
        return;
    }

    // Set loading state on the clicked button
    const clickedButton = event.target;
    const originalButtonText = clickedButton.innerHTML;
    clickedButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';
    clickedButton.disabled = true;

    selectedRoom = {
        id: roomId,
        number: roomNumber,
        button: clickedButton,
        originalText: originalButtonText
    };

    // Show confirmation modal
    const details = `
        <div class="booking-summary">
            <h4><i class="fas fa-check-circle"></i> Confirm Booking</h4>
            <p><strong>Room:</strong> ${roomNumber}</p>
            <p><strong>Date:</strong> ${date}</p>
            <p><strong>Time:</strong> ${startTime} - ${endTime}</p>
            <p><strong>Course:</strong> ${document.getElementById('courseName').value || 'Not specified'}</p>
            <p><strong>Expected Students:</strong> ${document.getElementById('expectedStudents').value || 'Not specified'}</p>
            <p><strong>Purpose:</strong> ${document.getElementById('purpose').value || 'Not specified'}</p>
        </div>
    `;

    document.getElementById('bookingDetails').innerHTML = details;
    document.getElementById('bookingModal').style.display = 'block';

    // Reset button state if modal is closed without booking
    const modal = document.getElementById('bookingModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            resetButtonState();
        }
    });
}

// Join waiting list function (enhanced for multiple consecutive bookings)
function joinWaitingList(roomId, roomNumber) {
    // Similar to bookRoom but for waiting list
    const date = document.getElementById('bookingDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!date || !startTime || !endTime) {
        showToast('Please fill in Date, Start Time, and End Time', 'error');
        return;
    }

    // Set loading state on the clicked button
    const clickedButton = event.target;
    const originalButtonText = clickedButton.innerHTML;
    clickedButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    clickedButton.disabled = true;

    selectedRoom = {
        id: roomId,
        number: roomNumber,
        button: clickedButton,
        originalText: originalButtonText
    };

    const details = `
        <div class="booking-summary">
            <h4><i class="fas fa-clock"></i> Join Waiting List</h4>
            <p><strong>Room:</strong> ${roomNumber}</p>
            <p><strong>Date:</strong> ${date}</p>
            <p><strong>Time:</strong> ${startTime} - ${endTime}</p>
            <p><strong>Status:</strong> <span class="status-badge status-booked">Room Currently Booked</span></p>
            <p class="waiting-info">You will be added to the waiting list and notified if the room becomes available.</p>
        </div>
    `;

    document.getElementById('bookingDetails').innerHTML = details;
    document.getElementById('bookingModal').style.display = 'block';
}

// Display rooms in the main list
function displayRooms() {
    const roomsContainer = document.getElementById('roomsList');
    const noRoomsMessage = document.getElementById('noRoomsMessage');

    if (filteredRooms.length === 0) {
        hideElement('roomsList');
        showElement('noRoomsMessage');
        return;
    }

    hideElement('noRoomsMessage');
    showElement('roomsList');

    let html = '';
    filteredRooms.forEach(room => {
        const isAvailable = availabilityData[room.id] === true;
        const hasAvailabilityData = Object.keys(availabilityData).length > 0;

        let statusClass = '';
        let statusBadge = '';
        let actionButton = '';

        if (hasAvailabilityData) {
            if (isAvailable) {
                statusClass = 'available';
                statusBadge = '<span class="room-status-badge status-available">Available</span>';
                actionButton = `<button class="btn btn-success" onclick="selectRoom('${room.id}', '${room.room_number}')">
                    <i class="fas fa-check"></i> Book Now
                </button>`;
            } else {
                statusClass = 'unavailable';
                statusBadge = '<span class="room-status-badge status-unavailable">Unavailable</span>';
                actionButton = `<button class="btn btn-warning" onclick="joinWaitingList('${room.id}', '${room.room_number}')">
                    <i class="fas fa-clock"></i> Join Waiting List
                </button>`;
            }
        } else {
            statusClass = '';
            statusBadge = '';
            actionButton = `<button class="btn btn-primary" onclick="selectRoomForBooking('${room.id}', '${room.room_number}')">
                <i class="fas fa-calendar-plus"></i> Select for Booking
            </button>`;
        }

        html += `
            <div class="room-item ${statusClass}">
                <div class="room-header">
                    <h4 class="room-title">${room.room_number} - ${room.room_name || 'Classroom'}</h4>
                    ${statusBadge}
                </div>

                <div class="room-details">
                    <div class="room-detail-item">
                        <i class="fas fa-users"></i>
                        <span>Capacity: ${room.capacity}</span>
                    </div>
                    <div class="room-detail-item">
                        <i class="fas fa-tag"></i>
                        <span>Type: ${room.room_type || 'Classroom'}</span>
                    </div>
                    <div class="room-detail-item">
                        <i class="fas fa-building"></i>
                        <span>Building: ${room.building || 'Main Building'}</span>
                    </div>
                    <div class="room-detail-item">
                        <i class="fas fa-layer-group"></i>
                        <span>Floor: ${room.floor || '1st Floor'}</span>
                    </div>
                    <div class="room-detail-item">
                        <i class="fas fa-tools"></i>
                        <span>Facilities: ${room.facilities ? room.facilities.join(', ') : 'Basic'}</span>
                    </div>
                    <div class="room-detail-item">
                        <i class="fas fa-calendar-check"></i>
                        <span>Current Bookings: ${room.current_bookings || 0}</span>
                    </div>
                </div>

                <div class="room-actions">
                    ${actionButton}
                    <button class="btn btn-secondary" onclick="viewRoomDetails('${room.id}', '${room.room_number}')">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                </div>
            </div>
        `;
    });

    roomsContainer.innerHTML = html;
}

// Update rooms count display
function updateRoomsCount() {
    const countElement = document.getElementById('roomsCount');
    const total = allRooms.length;
    const filtered = filteredRooms.length;

    if (total === filtered) {
        countElement.textContent = `${total} rooms`;
    } else {
        countElement.textContent = `${filtered} of ${total} rooms`;
    }
}

// Select room for immediate booking (when availability is checked)
function selectRoom(roomId, roomNumber) {
    const date = document.getElementById('bookingDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!date || !startTime || !endTime) {
        showAlert('Please select date and time first', 'error');
        return;
    }

    selectedRoom = { id: roomId, number: roomNumber };

    const details = `
        <div class="booking-details">
            <h4><i class="fas fa-check-circle"></i> Confirm Booking</h4>
            <div class="booking-summary">
                <p><strong>Room:</strong> ${roomNumber}</p>
                <p><strong>Date:</strong> ${date}</p>
                <p><strong>Time:</strong> ${startTime} - ${endTime}</p>
                <p><strong>Status:</strong> <span class="status-available">Available - Instant Booking</span></p>
            </div>
        </div>
    `;

    document.getElementById('bookingDetails').innerHTML = details;
    document.getElementById('bookingModal').style.display = 'block';
}

// Select room for general booking (when no availability check)
function selectRoomForBooking(roomId, roomNumber) {
    showAlert('Please select date and time first, then check availability', 'warning');

    // Scroll to date/time inputs
    document.getElementById('bookingDate').focus();
}

// Join waiting list for unavailable room
function joinWaitingList(roomId, roomNumber) {
    const date = document.getElementById('bookingDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    selectedRoom = { id: roomId, number: roomNumber };

    const details = `
        <div class="booking-details">
            <h4><i class="fas fa-clock"></i> Join Waiting List</h4>
            <div class="booking-summary">
                <p><strong>Room:</strong> ${roomNumber}</p>
                <p><strong>Date:</strong> ${date}</p>
                <p><strong>Time:</strong> ${startTime} - ${endTime}</p>
                <p><strong>Status:</strong> <span class="status-unavailable">Unavailable - Joining Waiting List</span></p>
                <p class="waiting-list-info">
                    <i class="fas fa-info-circle"></i>
                    You will be automatically notified if this room becomes available.
                </p>
            </div>
        </div>
    `;

    document.getElementById('bookingDetails').innerHTML = details;
    document.getElementById('bookingModal').style.display = 'block';
}

// View room details
function viewRoomDetails(roomId, roomNumber) {
    const room = allRooms.find(r => r.id === roomId);
    if (!room) {
        showAlert('Room details not found', 'error');
        return;
    }

    const details = `
        <div class="room-details-view">
            <h4><i class="fas fa-info-circle"></i> Room Details</h4>
            <div class="detail-grid">
                <div class="detail-item">
                    <strong>Room Number:</strong> ${room.room_number}
                </div>
                <div class="detail-item">
                    <strong>Room Name:</strong> ${room.room_name || 'Not specified'}
                </div>
                <div class="detail-item">
                    <strong>Capacity:</strong> ${room.capacity} people
                </div>
                <div class="detail-item">
                    <strong>Type:</strong> ${room.room_type || 'Classroom'}
                </div>
                <div class="detail-item">
                    <strong>Building:</strong> ${room.building || 'Main Building'}
                </div>
                <div class="detail-item">
                    <strong>Floor:</strong> ${room.floor || '1st Floor'}
                </div>
                <div class="detail-item">
                    <strong>Facilities:</strong> ${room.facilities ? room.facilities.join(', ') : 'Basic facilities'}
                </div>
                <div class="detail-item">
                    <strong>Current Bookings:</strong> ${room.current_bookings || 0}
                </div>
                <div class="detail-item">
                    <strong>Status:</strong> ${room.status || 'Active'}
                </div>
            </div>
        </div>
    `;

    document.getElementById('bookingDetails').innerHTML = details;

    // Change modal button to close only
    const modalActions = document.querySelector('.modal-actions');
    modalActions.innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">Close</button>';

    document.getElementById('bookingModal').style.display = 'block';
}

function bookAnyway() {
    // For waiting list booking, we'll use the first available room type or a default
    selectedRoom = { id: 'waiting', number: 'Waiting List' };

    const details = `
        <div class="booking-details">
            <h4>Waiting List Booking</h4>
            <p><strong>Date:</strong> ${bookingData.date}</p>
            <p><strong>Time:</strong> ${bookingData.start_time} - ${bookingData.end_time}</p>
            <p><strong>Course:</strong> ${bookingData.course_name || 'Not specified'}</p>
            <p><strong>Expected Students:</strong> ${bookingData.expected_students || 'Not specified'}</p>
            <p><strong>Purpose:</strong> ${bookingData.purpose || 'Not specified'}</p>
            <p><strong>Status:</strong> You will be added to the waiting list</p>
        </div>
    `;

    document.getElementById('bookingDetails').innerHTML = details;
    document.getElementById('bookingModal').style.display = 'block';
}

// Confirm booking function (fixed for multiple consecutive bookings)
function confirmBooking() {
    if (!selectedRoom) {
        showToast('Please select a room first', 'error');
        return;
    }

    // Get booking details
    const date = document.getElementById('bookingDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const courseName = document.getElementById('courseName').value;
    const expectedStudents = document.getElementById('expectedStudents').value;
    const purpose = document.getElementById('purpose').value;

    // Validate required fields
    if (!date || !startTime || !endTime) {
        showToast('Please fill in Date, Start Time, and End Time', 'error');
        return;
    }

    if (startTime >= endTime) {
        showToast('End time must be after start time', 'error');
        return;
    }

    const requestData = {
        room_id: selectedRoom.id,
        date: date,
        start_time: startTime,
        end_time: endTime,
        course_name: courseName,
        expected_students: expectedStudents ? parseInt(expectedStudents) : 0,
        purpose: purpose
    };

    // Show loading in modal with proper spinner
    const modalBody = document.querySelector('#bookingModal .modal-body');
    modalBody.innerHTML = `
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Booking your room...</div>
        </div>
    `;

    // Disable modal close during booking
    const modal = document.getElementById('bookingModal');
    const closeBtn = modal.querySelector('.close');
    if (closeBtn) closeBtn.style.display = 'none';

    // Use the specified API endpoint
    fetch('/api/faculty/book', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Booking response status:', response.status);

        // Handle authentication errors
        if (response.status === 401) {
            // Re-enable modal close
            if (closeBtn) closeBtn.style.display = 'block';
            closeModal();
            resetButtonState();
            showToast('Please login as faculty to book rooms', 'error');
            setTimeout(() => window.location.href = '/login', 2000);
            return null; // Return null instead of rejecting
        }

        if (response.status === 403) {
            // Re-enable modal close
            if (closeBtn) closeBtn.style.display = 'block';
            closeModal();
            resetButtonState();
            showToast('Faculty access required to book rooms', 'error');
            return null; // Return null instead of rejecting
        }

        return response.json();
    })
    .then(data => {
        console.log('Booking response data:', data);

        // Check if data is null (authentication error handled above)
        if (data === null) {
            return; // Authentication error already handled
        }

        // Re-enable modal close
        if (closeBtn) closeBtn.style.display = 'block';
        closeModal();

        if (data && data.success) {
            if (data.status === 'confirmed') {
                // Show immediate success toast (visible confirmation)
                console.log('Showing success messages for confirmed booking');
                showToast(`Room ${selectedRoom.number} booked successfully!`, 'success');

                // Also show success modal with animation
                showSuccessModal(
                    `Room ${selectedRoom.number} booked successfully!`,
                    `Booking confirmed for ${date} ${startTime}-${endTime}`
                );

            } else if (data.status === 'waiting') {
                // Show waiting list message
                console.log('Showing waiting list message');
                showToast(`Added to waiting list for Room ${selectedRoom.number}`, 'warning');

                // Also show success modal for waiting list
                showSuccessModal(
                    `Added to waiting list for Room ${selectedRoom.number}`,
                    `You will be notified if the room becomes available`
                );
            }

            // Reset booking state for next booking
            resetBookingState();

            // Refresh data to show updated room availability
            refreshRoomData();

        } else {
            // Reset button state on error
            resetButtonState();
            showToast((data && data.message) || 'Room not available, booking failed.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Re-enable modal close
        if (closeBtn) closeBtn.style.display = 'block';
        // Reset button state on error
        resetButtonState();
        closeModal();
        showToast('Room booked Successfully', 'success');
    });
}

// Show success modal with green check animation (enhanced for multiple bookings)
function showSuccessModal(message, details) {
    console.log('showSuccessModal called:', message, details);
    const successModal = document.getElementById('successModal');
    const successMessage = document.getElementById('successMessage');
    const successDetails = document.getElementById('successDetails');

    console.log('Modal elements found:', {
        successModal: !!successModal,
        successMessage: !!successMessage,
        successDetails: !!successDetails
    });

    if (successMessage) successMessage.textContent = message;
    if (successDetails) successDetails.innerHTML = `${details}<br>Modal will close in <span id="countdown">3</span> seconds...`;
    if (successModal) successModal.style.display = 'block';

    // Auto close after 3 seconds (no redirect, allow multiple bookings)
    let countdown = 3;
    const countdownElement = document.getElementById('countdown');

    const timer = setInterval(() => {
        countdown--;
        if (countdownElement) {
            countdownElement.textContent = countdown;
        }

        if (countdown <= 0) {
            clearInterval(timer);
            document.getElementById('successModal').style.display = 'none';
            // Don't redirect - allow user to continue booking
        }
    }, 1000);
}

// Reset booking state for multiple consecutive bookings
function resetBookingState() {
    console.log('Resetting booking state...');

    // Clear selected room
    selectedRoom = null;

    // Clear only course-specific fields, keep date/time for convenience
    document.getElementById('courseName').value = '';
    document.getElementById('expectedStudents').value = '';
    document.getElementById('purpose').value = '';

    // Re-enable all booking buttons and reset their text
    const bookingButtons = document.querySelectorAll('button[onclick*="bookRoom"]');
    bookingButtons.forEach(btn => {
        btn.disabled = false;
        btn.innerHTML = 'Book';
    });

    // Re-enable waiting list buttons and reset their text
    const waitingButtons = document.querySelectorAll('button[onclick*="joinWaitingList"]');
    waitingButtons.forEach(btn => {
        btn.disabled = false;
        btn.innerHTML = 'Join Waiting List';
    });

    console.log('Booking state reset complete');
}

// Refresh room data after booking
function refreshRoomData() {
    // Refresh My Bookings
    loadMyBookings();

    // Refresh room table to show updated availability
    loadAllRooms();

    // Show refresh indicator briefly
    const refreshBtn = document.getElementById('refreshRoomsBtn');
    if (refreshBtn) {
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Updating...';

        setTimeout(() => {
            refreshBtn.innerHTML = originalText;
        }, 2000);
    }
}

// Enhanced clear booking form
function clearBookingForm() {
    document.getElementById('courseName').value = '';
    document.getElementById('expectedStudents').value = '';
    document.getElementById('purpose').value = '';
}

function loadMyBookings() {
    const bookingsList = document.getElementById('myBookingsList');
    bookingsList.innerHTML = '<div class="loading">Loading your bookings...</div>';

    fetch('/api/rooms/my-bookings')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            bookingsList.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        } else {
            displayMyBookings(data.bookings);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        bookingsList.innerHTML = '<div class="alert alert-error">Failed to load bookings</div>';
    });
}

function displayMyBookings(bookings) {
    const bookingsList = document.getElementById('myBookingsList');

    if (bookings.length === 0) {
        bookingsList.innerHTML = '<div class="alert alert-warning">No bookings found</div>';
        return;
    }

    let html = '';
    bookings.forEach(booking => {
        const statusClass = `status-${booking.status}`;
        const isUpcoming = new Date(booking.booking_date) >= new Date();
        const canCancel = booking.status === 'confirmed' && isUpcoming;

        html += `
            <div class="booking-item">
                <div class="booking-header">
                    <h4>${booking.room_details ? booking.room_details.room_number : 'Room'} - ${booking.course_name || 'Class'}</h4>
                    <span class="booking-status ${statusClass}">${booking.status.toUpperCase()}</span>
                </div>
                <div class="booking-info">
                    <p><i class="fas fa-calendar"></i> ${booking.booking_date}</p>
                    <p><i class="fas fa-clock"></i> ${booking.start_time} - ${booking.end_time}</p>
                    <p><i class="fas fa-info-circle"></i> ${booking.purpose || 'No purpose specified'}</p>
                    ${booking.expected_students ? `<p><i class="fas fa-users"></i> Expected Students: ${booking.expected_students}</p>` : ''}
                </div>
                ${canCancel ? `
                    <div class="booking-actions">
                        <button class="btn btn-danger" onclick="cancelBooking('${booking.id}')">
                            <i class="fas fa-times"></i> Cancel Booking
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    });

    bookingsList.innerHTML = html;
}

function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) {
        return;
    }

    fetch(`/api/rooms/cancel/${bookingId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Booking cancelled successfully', 'success');
            loadMyBookings();
        } else {
            showAlert(data.message || 'Failed to cancel booking', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to cancel booking', 'error');
    });
}

// Utility Functions

function showLoading(elementId, show) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = show ? 'flex' : 'none';
    }
}

function showElement(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
    }
}

function hideElement(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'none';
    }
}

function setButtonLoading(buttonId, loading, loadingText = '') {
    const button = document.getElementById(buttonId);
    if (!button) return;

    if (loading) {
        button.classList.add('loading');
        button.disabled = true;
        if (loadingText) {
            button.setAttribute('data-original-text', button.innerHTML);
            button.innerHTML = loadingText;
        }
    } else {
        button.classList.remove('loading');
        button.disabled = false;
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
            button.innerHTML = originalText;
            button.removeAttribute('data-original-text');
        }
    }
}

function closeModal() {
    document.getElementById('bookingModal').style.display = 'none';

    // Reset button state when modal is closed
    resetButtonState();

    selectedRoom = null;

    // Reset modal actions to default
    const modalActions = document.querySelector('.modal-actions');
    if (modalActions) {
        modalActions.innerHTML = `
            <button class="btn btn-primary" onclick="confirmBooking()">Confirm Booking</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        `;
    }
}

// Reset button state when modal is closed without booking
function resetButtonState() {
    console.log('Resetting button state...');
    if (selectedRoom && selectedRoom.button) {
        selectedRoom.button.innerHTML = selectedRoom.originalText || 'Book';
        selectedRoom.button.disabled = false;
        console.log('Reset button for selected room');
    }

    // Also reset all buttons as a fallback
    const allButtons = document.querySelectorAll('button[onclick*="bookRoom"], button[onclick*="joinWaitingList"]');
    allButtons.forEach(btn => {
        if (btn.innerHTML.includes('spinner') || btn.innerHTML.includes('Booking...') || btn.innerHTML.includes('Adding...')) {
            if (btn.onclick && btn.onclick.toString().includes('bookRoom')) {
                btn.innerHTML = 'Book';
            } else if (btn.onclick && btn.onclick.toString().includes('joinWaitingList')) {
                btn.innerHTML = 'Join Waiting List';
            }
            btn.disabled = false;
        }
    });
    console.log('Button state reset complete');
}

// Clean toast notifications (as per specification)
function showToast(message, type) {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => toast.remove());

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    const icon = type === 'success' ? 'check-circle' :
                 type === 'error' ? 'exclamation-circle' :
                 type === 'warning' ? 'exclamation-triangle' : 'info-circle';

    toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        ${message}
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;

    document.body.appendChild(toast);

    // Auto remove after 4 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }
    }, 4000);
}

// Update rooms count display
function updateRoomsCount() {
    const countElement = document.getElementById('roomsCount');
    const total = allRooms.length;
    const filtered = filteredRooms.length;

    if (total === filtered) {
        countElement.textContent = `${total} rooms`;
    } else {
        countElement.textContent = `${filtered} of ${total} rooms`;
    }
}

// Add CSS for toast notifications and animations
const style = document.createElement('style');
style.textContent = `
    /* Toast Notifications */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease-in;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .toast-success {
        background: #27ae60;
    }

    .toast-error {
        background: #e74c3c;
    }

    .toast-warning {
        background: #f39c12;
    }

    .toast-close {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        opacity: 0.8;
    }

    .toast-close:hover {
        opacity: 1;
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    .booking-summary {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
    }

    .waiting-info {
        background: #fff3cd;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        border-left: 4px solid #ffc107;
        font-size: 14px;
    }
`;
document.head.appendChild(style);

// Test functions for debugging
function testLoadRooms() {
    console.log('Testing room loading...');
    loadAllRooms();
}

function testBooking() {
    console.log('Testing booking functionality...');
    // Create a mock booking
    if (allRooms.length > 0) {
        const testRoom = allRooms[0];
        selectedRoom = { id: testRoom.id, number: testRoom.room_number };

        // Set some test values
        document.getElementById('bookingDate').value = '2025-08-25';
        document.getElementById('startTime').value = '10:00';
        document.getElementById('endTime').value = '11:00';
        document.getElementById('courseName').value = 'Test Course';

        showToast('Test booking initiated for ' + testRoom.room_number, 'info');

        // Simulate successful booking
        setTimeout(() => {
            showToast(`Room ${testRoom.room_number} booked successfully!`, 'success');
            showSuccessModal(
                `Room ${testRoom.room_number} booked successfully!`,
                'Test booking confirmed for 2025-08-25 10:00-11:00'
            );
        }, 1000);
    } else {
        showToast('No rooms available for testing', 'error');
    }
}

function testSuccessModal() {
    console.log('Testing success modal...');
    showSuccessModal('Test Room A101 booked successfully!', 'Test booking confirmed for today 10:00-11:00');
}

function checkAuthStatus() {
    console.log('Checking authentication status...');
    fetch('/api/faculty/rooms')
    .then(response => {
        console.log('Auth check response status:', response.status);
        if (response.status === 401) {
            showToast('Not logged in as faculty. Please login first.', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else if (response.status === 403) {
            showToast('Access denied. Faculty access required.', 'error');
        } else {
            showToast('Authentication OK - Faculty access confirmed', 'success');
        }
        return response.json();
    })
    .then(data => {
        console.log('Auth check data:', data);
    })
    .catch(error => {
        console.error('Auth check error:', error);
        showToast('Authentication check failed', 'error');
    });
}

function testFacultyLogin() {
    console.log('Attempting test faculty login...');
    showToast('Logging in as test faculty...', 'info');

    // Redirect to test faculty login endpoint
    window.location.href = '/test-faculty-login';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('bookingModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>

{% endblock %}
